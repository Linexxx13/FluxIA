<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Carrinho - FluxIA</title>
    
    <link rel="stylesheet" href="https://maxst.icons8.com/vue-static/landings/line-awesome/line-awesome/1.3.0/css/line-awesome.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/imask/6.4.3/imask.min.js"></script>

    <style>
        :root { 
            --bg-body: #050a14; 
            --bg-card: #16213e; 
            --primary: #00F8A5; 
            --text: #fff; 
            --input-bg: #0f172a; 
            --header-bg: rgba(5, 10, 20, 0.9);
        }

        /* Reset de Links e Proteção contra Roxo */
        * { box-sizing: border-box; outline: none; text-decoration: none !important; }
        a, a:visited, a:active { color: inherit; }

        body { 
            font-family: 'Outfit', sans-serif; 
            background: var(--bg-body); 
            color: var(--text); 
            padding-bottom: 50px; 
            padding-top: 100px; /* Espaço para o header fixo */
            margin: 0; 
        }

        /* --- HEADER GLOBAL --- */
        header { 
            background: var(--header-bg); 
            padding: 15px 5%; 
            position: fixed; 
            top: 0; 
            width: 100%;
            z-index: 1000; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            border-bottom: 1px solid rgba(255,255,255,0.1); 
            backdrop-filter: blur(10px); 
        }
        
        .brand-logo { 
            color: var(--primary); 
            font-family: 'Space Mono', monospace; 
            font-size: 1.5rem; 
            font-weight: bold; 
            cursor: pointer;
        }

        nav { display: flex; align-items: center; gap: 20px; }
        nav a { 
            color: var(--text) !important; 
            font-weight: 500; 
            font-size: 0.9rem; 
            transition: 0.3s; 
        }
        nav a:hover { color: var(--primary) !important; }

        /* Perfil Dropdown */
        .profile-icon-container { position: relative; cursor: pointer; margin-left: 10px; }
        .profile-icon { font-size: 28px; color: var(--primary); }
        .profile-dropdown-menu {
            position: absolute; top: 100%; right: 0; margin-top: 15px;
            background-color: var(--bg-card); border: 1px solid rgba(255,255,255,0.1);
            border-radius: 8px; min-width: 200px; padding: 15px; display: none;
            box-shadow: 0 10px 25px rgba(0,0,0,0.5); z-index: 1001;
        }
        .profile-dropdown-menu.show { display: block; }
        .profile-dropdown-menu h4 { color: var(--primary); font-size: 0.9rem; margin-bottom: 10px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 8px; }
        .profile-dropdown-menu a { display: block; padding: 8px 0; color: var(--text) !important; font-size: 0.85rem; }
        .profile-dropdown-menu a:hover { color: var(--primary) !important; }

        /* --- CONTEÚDO --- */
        .top-bar { max-width: 1200px; margin: 20px auto 0; padding: 0 20px; }
        .btn-back-store { display: inline-flex; align-items: center; gap: 8px; color: var(--primary); font-weight: 600; transition: 0.3s; padding: 10px 0; cursor: pointer; }
        .btn-back-store:hover { transform: translateX(-5px); filter: brightness(1.2); }

        .container { max-width: 1200px; margin: 10px auto; padding: 0 20px; display: grid; grid-template-columns: 1.1fr 0.9fr; gap: 30px; }
        
        .card-box { background: var(--bg-card); padding: 25px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.05); margin-bottom: 20px; }
        h3 { color: var(--primary); margin-bottom: 15px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 10px; margin-top: 0; }
        
        .input-group { margin-bottom: 15px; }
        label { font-size: 0.8rem; color: #aaa; margin-bottom: 5px; display: block; }
        input, select { width: 100%; padding: 12px; background: var(--input-bg); border: 1px solid #333; color: #fff; border-radius: 6px; }

        /* PAGAMENTO E ABAS */
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; background: var(--input-bg); padding: 5px; border-radius: 8px; }
        .tab-btn { flex: 1; padding: 12px; border: none; background: transparent; color: #94a3b8; cursor: pointer; border-radius: 6px; font-weight: 600; transition: 0.3s; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .tab-btn.active { background: var(--bg-card); color: var(--primary); border: 1px solid var(--primary); }
        
        .payment-form { display: none; }
        .payment-form.active { display: block; animation: fadeIn 0.3s; }
        
        /* ITENS DO CARRINHO */
        .cart-item { display: flex; align-items: center; gap: 15px; padding: 15px 0; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .cart-img { width: 55px; height: 55px; border-radius: 8px; object-fit: cover; border: 1px solid rgba(255,255,255,0.1); background: #000; }
        
        .item-info { flex: 1; }
        .item-name { font-weight: 600; display: block; font-size: 0.9rem; }
        .qty-controls { display: flex; align-items: center; gap: 8px; background: var(--input-bg); padding: 4px 8px; border-radius: 6px; }
        .qty-btn { background: rgba(255,255,255,0.1); color: #fff; border: none; width: 22px; height: 22px; border-radius: 4px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .item-total { font-weight: bold; color: var(--primary); min-width: 70px; text-align: right; }

        .btn-action { width: 100%; padding: 18px; background: var(--primary); color: #000; border: none; border-radius: 8px; font-weight: bold; font-size: 1.1rem; cursor: pointer; margin-top: 20px; transition: 0.3s; opacity: 0.5; pointer-events: none; }
        .btn-action.ready { opacity: 1; pointer-events: all; }

        .pix-area { display: none; text-align: center; margin-top: 20px; border-top: 1px solid #333; padding-top: 20px; }
        .qr-box { background: #fff; padding: 10px; width: 160px; height: 160px; margin: 0 auto; border-radius: 8px; }
        .pix-key { font-family: monospace; background: #000; padding: 10px; border-radius: 4px; color: var(--primary); font-size: 0.75rem; word-break: break-all; margin-top: 10px; cursor: pointer; }

        @media (max-width: 850px) { .container { grid-template-columns: 1fr; } }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <header>
        <div class="brand-logo" onclick="window.location.href='loja.html'">FluxIA</div>
        <nav>
            <a href="Fluxiainicio.html">Início</a>
            <a href="calcular rotas.html">Calcular Rota</a>
            <a href="estoque.html">Sistema de Estoque</a>
            <a href="loja.html">Loja</a>
            <a href="contato.html">Contato</a>
        </nav>
    </header>

    <div class="top-bar">
        <div class="btn-back-store" onclick="window.location.href='loja.html'">
            <i class="las la-arrow-left"></i> Continuar Comprando
        </div>
    </div>

    <div class="container">
        <div>
            <div class="card-box">
                <h3><i class="las la-user"></i> Seus Dados</h3>
                <div class="input-group"><label>Nome Completo</label><input type="text" id="nome" oninput="validar()"></div>
                <div class="input-group"><label>Telefone / WhatsApp</label><input type="text" id="telefone" oninput="validar()"></div>
            </div>
            
            <div class="card-box">
                <h3><i class="las la-map-marker"></i> Entrega</h3>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                    <div class="input-group"><label>CEP</label><input type="text" id="cep" placeholder="00000-000" onblur="buscarCep()"></div>
                    <div class="input-group"><label>Número</label><input type="number" id="numero" oninput="validar()"></div>
                </div>

                <div class="input-group">
                    <label>Tipo de Residência</label>
                    <select id="tipo-residencia" onchange="mudarTipoResidencia()">
                        <option value="Casa">Casa</option>
                        <option value="Apartamento">Apartamento</option>
                    </select>
                </div>

                <div id="campos-apartamento" style="display:none; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:15px;">
                    <div class="input-group"><label>Bloco</label><input type="text" id="bloco" placeholder="Ex: A"></div>
                    <div class="input-group"><label>Número AP</label><input type="text" id="num-ap" placeholder="Ex: 42"></div>
                </div>

                <div class="input-group"><label>Complemento</label><input type="text" id="complemento"></div>
                <div class="input-group"><label>Endereço Automático</label><input type="text" id="endereco" readonly></div>
            </div>
        </div>

        <div>
            <div class="card-box">
                <h3><i class="las la-shopping-cart"></i> Produtos</h3>
                <div id="cart-list"></div>
            </div>

            <div class="card-box" style="position: sticky; top: 120px;">
                <h3>Resumo & Pagamento</h3>
                
                <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                    <span>Subtotal</span><span id="lbl-subtotal">R$ 0,00</span>
                </div>
                <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                    <span>Frete</span><span style="color:var(--primary); font-weight:bold;">Grátis</span>
                </div>
                <div style="display:flex; justify-content:space-between; font-size:1.4rem; color:var(--primary); font-weight:bold; margin:15px 0; border-top:1px solid #333; padding-top:15px;">
                    <span>Total</span><span id="lbl-total">R$ 0,00</span>
                </div>

                <div class="tabs">
                    <button class="tab-btn active" onclick="setMethod('pix')"><i class="las la-qrcode"></i> Pix</button>
                    <button class="tab-btn" onclick="setMethod('card')"><i class="las la-credit-card"></i> Cartão</button>
                </div>

                <div id="form-pix" class="payment-form active">
                    <button id="btn-gerar" class="btn-action" onclick="gerarPixTela()">Confirmar e Gerar Pix</button>
                    <div id="pix-area" class="pix-area">
                        <div class="qr-box"><img id="qr-img" src="" style="width:100%; height:100%;"></div>
                        <div class="pix-key" id="pix-code" onclick="copiar()">...</div>
                        <button class="btn-action ready" onclick="finalizarCompraComBaixa('Pix')" style="background: var(--primary); color: #000; margin-top: 15px;">
                            Confirmar Pagamento
                        </button>
                    </div>
                </div>

                <div id="form-card" class="payment-form">
                    <div class="input-group"><label>Número do Cartão</label><input type="text" id="cc-num" placeholder="0000 0000 0000 0000"></div>
                    <button class="btn-action" id="btn-card" onclick="finalizarCompraComBaixa('Cartão')">Finalizar Pedido (Cartão)</button>
                </div>
            </div>
        </div>
    </div>

    <script>
// --- CONFIGURAÇÕES ORIGINAIS ---
const PIX_CHAVE = "11932047878"; 
const PIX_NOME = "Lucas Martins Oliveira";
const PIX_CIDADE = "Sao Bernardo do Campo";

const firebaseConfig = {
    apiKey: "AIzaSyD_U4aMQZLipqy8Ul9Pjdd6pqtXxY5om_s", 
    authDomain: "fluxia-estoque.firebaseapp.com",
    projectId: "fluxia-estoque",
    storageBucket: "fluxia-estoque.firebasestorage.app",
    messagingSenderId: "227345206289",
    appId: "1:227345206289:web:87a932467401320e0935b0"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

let cart = JSON.parse(localStorage.getItem('fluxiaCart')) || [];
let subtotal = 0, frete = 0, total = 0, pixCodeGlobal = "";

IMask(document.getElementById('cep'), {mask: '00000-000'});
IMask(document.getElementById('cc-num'), {mask: '0000 0000 0000 0000'});

// --- FUNÇÕES DE INTERFACE ORIGINAIS ---
function renderCart() {
    const list = document.getElementById('cart-list');
    list.innerHTML = ''; subtotal = 0;
    if(cart.length === 0) {
        list.innerHTML = "<p style='color:#777; text-align:center; padding:20px;'>Carrinho vazio.</p>";
        atualizarTotais(); validar(); return;
    }
    cart.forEach((item, index) => {
        subtotal += item.price * item.qty;
        list.innerHTML += `
            <div class="cart-item">
                <img src="${item.imageUrl || ''}" class="cart-img">
                <div class="item-info">
                    <span class="item-name">${item.name}</span>
                </div>
                <div class="qty-controls">
                    <button class="qty-btn" onclick="alterarQtd(${index}, -1)">-</button>
                    <span class="qty-num">${item.qty}</span>
                    <button class="qty-btn" onclick="alterarQtd(${index}, 1)">+</button>
                </div>
                <div class="item-total">R$ ${(item.price * item.qty).toFixed(2)}</div>
            </div>`;
    });
    atualizarTotais(); validar();
}

function alterarQtd(index, change) {
    const item = cart[index];
    const novaQtd = item.qty + change;
    if (change > 0 && novaQtd > item.stock) {
        alert(`Limite de estoque atingido! (Máximo: ${item.stock})`);
        return;
    }
    if (novaQtd <= 0) {
        cart.splice(index, 1);
    } else {
        item.qty = novaQtd;
    }
    localStorage.setItem('fluxiaCart', JSON.stringify(cart));
    renderCart();
}

async function buscarCep() {
    const cep = document.getElementById('cep').value.replace(/\D/g, '');
    if(cep.length !== 8) return;
    const res = await fetch(`https://viacep.com.br/ws/${cep}/json/`);
    const data = await res.json();
    if(!data.erro) {
        document.getElementById('endereco').value = `${data.logradouro}, ${data.bairro} - ${data.localidade}/${data.uf}`;
        validar();
    }
}

function atualizarTotais() {
    total = subtotal + frete;
    document.getElementById('lbl-subtotal').innerText = subtotal.toLocaleString('pt-BR',{style:'currency',currency:'BRL'});
    document.getElementById('lbl-total').innerText = total.toLocaleString('pt-BR',{style:'currency',currency:'BRL'});
}

function validar() {
    const nome = document.getElementById('nome').value;
    const cep = document.getElementById('cep').value;
    const ready = (nome && cep.length >= 8 && cart.length > 0);
    document.getElementById('btn-gerar').className = ready ? 'btn-action ready' : 'btn-action';
    document.getElementById('btn-card').className = ready ? 'btn-action ready' : 'btn-action';
}

function setMethod(m) {
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    document.querySelectorAll('.payment-form').forEach(f => f.classList.remove('active'));
    if(m === 'pix') {
        document.querySelectorAll('.tab-btn')[0].classList.add('active');
        document.getElementById('form-pix').classList.add('active');
    } else {
        document.querySelectorAll('.tab-btn')[1].classList.add('active');
        document.getElementById('form-card').classList.add('active');
    }
}

function mudarTipoResidencia() {
    document.getElementById('campos-apartamento').style.display = document.getElementById('tipo-residencia').value === 'Apartamento' ? 'grid' : 'none';
}

// --- LÓGICA DE PIX ORIGINAL ---
function gerarPixTela() {
    pixCodeGlobal = montarPayloadPix(total);
    document.getElementById('btn-gerar').style.display = 'none';
    document.getElementById('pix-area').style.display = 'block';
    document.getElementById('pix-code').innerText = pixCodeGlobal;
    document.getElementById('qr-img').src = `https://api.qrserver.com/v1/create-qr-code/?size=250x250&data=${encodeURIComponent(pixCodeGlobal)}`;
}

function copiar() { navigator.clipboard.writeText(pixCodeGlobal).then(()=>alert("Código Copiado!")); }

// --- LOGICA DE FINALIZAÇÃO E BAIXA DE ESTOQUE ---
async function finalizarCompraComBaixa(metodo) {
    if (cart.length === 0) return;

    try {
        const batch = db.batch();
        const nomeCliente = document.getElementById('nome').value;

        // 1. Registrar a venda
        const vendaRef = db.collection('vendas').doc();
        batch.set(vendaRef, { 
            cliente: nomeCliente,
            itens: cart, 
            total: total, 
            data: new Date(), 
            metodo: metodo 
        });

        // 2. Dar baixa no estoque
        cart.forEach(item => {
            const productRef = db.collection("inventory").doc(item.id);
            batch.update(productRef, {
                quantity: firebase.firestore.FieldValue.increment(-item.qty)
            });
        });

        await batch.commit();
        
        // 3. Limpar carrinho e avisar
        localStorage.removeItem('fluxiaCart');
        alert("Pagamento confirmado! O estoque foi atualizado com sucesso.");
        window.location.href = 'loja.html';

    } catch (error) {
        console.error("Erro ao finalizar compra:", error);
        alert("Houve um erro ao processar seu pedido.");
    }
}

// --- GERADOR DE PAYLOAD PIX (ORIGINAL) ---
function montarPayloadPix(valor) {
    const v = valor.toFixed(2);
    const chave = "+55" + PIX_CHAVE;
    const nome = PIX_NOME.normalize("NFD").replace(/[\u0300-\u036f]/g, "").substring(0, 25);
    const cidade = PIX_CIDADE.normalize("NFD").replace(/[\u0300-\u036f]/g, "").substring(0, 15);

    let payload = "000201"; 
    payload += formatarCampo("26", "0014BR.GOV.BCB.PIX" + formatarCampo("01", chave));
    payload += "520400005303986"; 
    payload += formatarCampo("54", v);
    payload += "5802BR";
    payload += formatarCampo("59", nome);
    payload += formatarCampo("60", cidade);
    payload += formatarCampo("62", formatarCampo("05", "***"));
    payload += "6304";

    const crc = crc16ccitt(payload);
    return payload + crc;
}

function formatarCampo(id, valor) {
    const len = valor.length.toString().padStart(2, '0');
    return id + len + valor;
}

function crc16ccitt(payload) {
        let crc = 0xFFFF;
        const polynomial = 0x1021;
        for (let i = 0; i < payload.length; i++) {
            crc ^= (payload.charCodeAt(i) << 8);
            for (let j = 0; j < 8; j++) {
                if ((crc & 0x8000) !== 0) crc = (crc << 1) ^ polynomial;
                else crc = crc << 1;
            }
        }
        return (crc & 0xFFFF).toString(16).toUpperCase().padStart(4, '0');
    }

    // --- CORREÇÃO: INICIALIZAR O CARRINHO AO CARREGAR A PÁGINA ---
    renderCart();
    </script>
</body>
</html>